<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionar Aplicaciones - My Store (PRO)</title>

  <style>
    /* -------------------------
       Paleta y variables (manteniendo el estilo)
       ------------------------- */
    :root{
      --primary:#6366f1;
      --primary-600:#4f46e5;
      --accent:#06b6d4;
      --danger:#ef4444;
      --bg-light: linear-gradient(135deg,#eef2ff,#fff7ed);
      --bg-dark: linear-gradient(135deg,#0f1724,#1e293b);
      --card-light:#ffffff;
      --card-dark:#0b1220;
      --text-light:#0f1724;
      --text-dark:#f8fafc;
      --glass: rgba(255,255,255,0.6);
      --muted:#6b7280;
      --shadow: 0 10px 30px rgba(2,6,23,0.06);
      --radius:12px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}

    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg-light);
      color:var(--text-light);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    body.dark{
      background:var(--bg-dark);
      color:var(--text-dark);
    }

    a{color:var(--primary); text-decoration:none;}
    img{display:block; max-width:100%;}

    /* header */
    header.app-header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 20px; background:rgba(255,255,255,0.92);
      backdrop-filter: blur(6px); box-shadow:0 6px 20px rgba(2,6,23,0.06);
    }
    body.dark header.app-header{ background:rgba(10,18,28,0.6); box-shadow:0 6px 20px rgba(0,0,0,0.6); }

    .brand{display:flex; align-items:center; gap:12px;}
    .brand img{width:44px; height:44px; border-radius:9px; object-fit:cover;}
    .brand h1{font-size:1.05rem; margin:0; font-weight:700; letter-spacing:-0.2px;}

    .header-actions{display:flex; align-items:center; gap:8px;}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer; border:none; font-weight:600;
      background:var(--primary); color:white; box-shadow:0 6px 18px rgba(79,70,229,0.12);
    }
    .btn.secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:inherit; font-weight:600; box-shadow:none;}
    .small{padding:6px 10px; font-size:0.9rem;}
    .muted { color: var(--muted); font-weight:500; }

    /* container */
    main.container{ max-width:1200px; margin:20px auto 80px; padding:0 18px; z-index:20; position:relative;}
    .topbar{ display:flex; gap:12px; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    h2.title{ margin:0; color:var(--primary-600); font-size:1.35rem; }

    /* controls */
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .search{
      display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; min-width:260px;
      background:var(--card-light); box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.04);
    }
    .search input{ border:none; outline:none; font-size:14px; min-width:180px; background:transparent; color:inherit; }
    .select, .tiny-btn{ padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:var(--card-light); }

    /* grid */
    .apps-grid{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); align-items:stretch; }

    .card{
      background:var(--card-light); padding:14px; border-radius:var(--radius); position:relative; overflow:hidden;
      box-shadow:var(--shadow); transition: transform 0.28s cubic-bezier(.2,.8,.2,1), box-shadow .28s;
      display:flex; flex-direction:column; gap:10px; min-height:220px;
    }
    body.dark .card{ background:var(--card-dark); box-shadow:0 8px 26px rgba(0,0,0,0.6); }
    .card:hover{ transform:translateY(-6px); box-shadow:0 18px 44px rgba(2,6,23,0.12); }

    .meta{ display:flex; gap:12px; align-items:center; }
    .meta img{ width:64px; height:64px; border-radius:12px; object-fit:cover; }
    .meta .info h3{ margin:0; font-size:1.05rem; color:var(--primary-600); }
    .meta .info small{ color: var(--muted); display:block; margin-top:6px; font-size:0.86rem; }

    .desc{ color:#374151; font-size:0.95rem; line-height:1.35; flex:1; }
    .card-actions{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; }

    .link-apk{ color:var(--accent); font-weight:600; font-size:0.92rem; text-decoration:none; }

    .danger{ background:var(--danger); color:white; padding:8px 12px; border-radius:10px; font-weight:700; border:none; cursor:pointer; }
    .edit{ background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; }

    /* toast */
    .toast{ position:fixed; right:18px; bottom:18px; background: #10b981; color:white; padding:12px 18px; border-radius:10px; box-shadow:0 12px 40px rgba(2,6,23,0.18); opacity:0; transform: translateY(8px); transition:all .32s; z-index:9999;}
    .toast.show{ opacity:1; transform: translateY(0); }

    /* modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.45); display:flex; align-items:center; justify-content:center; z-index:9998; padding:20px; }
    .modal{
      width:100%; max-width:820px; background:var(--card-light); border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(2,6,23,0.35);
      max-height:92vh; overflow:auto;
    }
    .modal .row{ display:flex; gap:12px; margin-bottom:12px; align-items:center; flex-wrap:wrap; }
    .modal label{ font-weight:700; font-size:0.9rem; margin-bottom:6px; display:block; }
    .modal input[type="text"], .modal textarea{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
    .modal input[type="file"]{ padding:8px; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }

    .preview{ width:92px; height:92px; border-radius:10px; object-fit:cover; border:1px solid rgba(0,0,0,0.06); }

    /* small spinner */
    .spinner{ width:14px; height:14px; border-radius:999px; border:3px solid rgba(255,255,255,0.2); border-top-color:white; animation:spin1 .7s linear infinite; display:inline-block; }
    @keyframes spin1{ to{ transform:rotate(360deg); } }

    /* responsive tweaks */
    @media (max-width:900px){
      .meta img{ width:56px; height:56px; }
      .card{ padding:12px; }
      main.container{ padding:0 14px; }
      .modal{ max-width:92%; padding:14px; }
    }
    @media (max-width:520px){
      header.app-header{ padding:10px; flex-direction:column; gap:8px; align-items:flex-start; }
      .controls{ width:100%; justify-content:flex-start; }
      .search{ min-width:unset; flex:1; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <div class="brand">
      <img src="logo.png" alt="logo" />
      <div>
        <h1>My Store ¬∑ Panel</h1>
        <small class="muted">Gesti√≥n de aplicaciones ¬∑ manage-apps</small>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn small" id="refreshBtn">üîÑ Actualizar</button>
      <button class="btn small" id="newBtn" style="background:var(--accent); box-shadow:0 6px 20px rgba(6,182,212,0.18)">‚ûï Nueva app</button>
      <a class="btn small secondary" id="backBtn" href="admin.html" style="background:transparent; border:1px solid rgba(0,0,0,0.06)">‚Ü©Ô∏è Volver al panel principal</a>
    </div>
  </header>

  <main class="container" role="main">
    <div class="topbar">
      <h2 class="title">üìã Administrar Aplicaciones</h2>

      <div class="controls" aria-label="Filtros">
        <div class="search" role="search" aria-label="Buscar apps">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M21 21l-4.35-4.35" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="5" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchInput" type="text" placeholder="Buscar por nombre..." aria-label="Buscar por nombre" />
        </div>

        <select id="categorySelect" class="select" aria-label="Filtrar por categor√≠a">
          <option value="">Todas las categor√≠as</option>
        </select>

        <select id="sortSelect" class="select" aria-label="Ordenar">
          <option value="new">M√°s recientes</option>
          <option value="old">M√°s antiguas</option>
          <option value="name_asc">Nombre A ‚Üí Z</option>
          <option value="name_desc">Nombre Z ‚Üí A</option>
        </select>

        <button class="tiny-btn" id="clearFilter">Limpiar</button>
      </div>
    </div>

    <!-- GRID -->
    <div id="appsGrid" class="apps-grid" aria-live="polite">
      <!-- cards injected here -->
    </div>
  </main>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- EDIT / CREATE MODAL (hidden by default) -->
  <div id="modalBackdrop" class="modal-backdrop" style="display:none;" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Editar aplicaci√≥n</h3>

      <form id="modalForm">
        <input type="hidden" id="modalId" name="id" />
        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label for="modalName">Nombre</label>
            <input id="modalName" name="name" type="text" placeholder="Nombre de la app" required />
          </div>
          <div style="width:120px; display:flex; flex-direction:column; gap:8px; align-items:center;">
            <label>Preview</label>
            <img id="modalPreview" class="preview" src="placeholder.png" alt="preview" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label for="modalDesc">Descripci√≥n</label>
          <textarea id="modalDesc" name="description" rows="4" placeholder="Descripci√≥n corta"></textarea>
        </div>

        <div style="display:flex;gap:12px; margin-top:8px; flex-wrap:wrap; align-items:center;">
          <div>
            <label for="modalImage">Imagen (PNG/JPG)</label>
            <input id="modalImage" name="image" type="file" accept="image/*" />
          </div>
          <div>
            <label for="modalApk">APK</label>
            <input id="modalApk" name="apk" type="file" accept=".apk" />
          </div>
        </div>

        <div class="actions" style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
          <button type="button" id="modalCancel" class="btn secondary">Cancelar</button>
          <button type="submit" id="modalSave" class="btn" style="background:var(--primary-600)">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Estado ----------
    let apps = [];
    let filter = { q:'', category:'', sort:'new' };
    let editingId = null;
    let lastObjectUrl = null;
    const toastEl = document.getElementById('toast');
    const appsGrid = document.getElementById('appsGrid');

    // ---------- Helpers ----------
    function showToast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.style.background = ok ? '#10b981' : '#ef4444';
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 3000);
    }

    function formatDate(sqlDate){
      try{ const d = new Date(sqlDate); return d.toLocaleString(); } catch { return sqlDate; }
    }

    // ---------- safeFetch ----------
    async function safeFetch(path, opts = {}){
      const cfg = {
        credentials: 'include',
        ...opts
      };
      const res = await fetch(path, cfg);
      const ctype = res.headers.get('content-type') || '';
      if(ctype.includes('application/json')){
        const json = await res.json();
        if(!res.ok) throw Object.assign(new Error(json.message || 'Error'), { status: res.status, body: json });
        return json;
      } else {
        const text = await res.text();
        if(!res.ok) throw Object.assign(new Error(text || 'Error'), { status: res.status, body: text });
        return text;
      }
    }

    // ---------- Render seguro ----------
    function escapeHtml(str=''){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }

    function renderApps(){
      const q = filter.q.trim().toLowerCase();
      let list = apps.filter(a => (a.name && a.name.toLowerCase().includes(q)) || (a.description && a.description.toLowerCase().includes(q)));
      if(filter.category) list = list.filter(a=>a.category===filter.category);

      // sorting
      if(filter.sort==='new') list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      if(filter.sort==='old') list.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
      if(filter.sort==='name_asc') list.sort((a,b)=> a.name.localeCompare(b.name));
      if(filter.sort==='name_desc') list.sort((a,b)=> b.name.localeCompare(a.name));

      appsGrid.innerHTML = '';
      if(list.length===0){
        appsGrid.innerHTML = '<p style="text-align:center; color:var(--muted)">No se encontraron aplicaciones.</p>';
        return;
      }

      list.forEach((app, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.animationDelay = (idx*40)+'ms';

        // meta
        const meta = document.createElement('div'); meta.className='meta';
        const img = document.createElement('img'); img.src = app.image || 'placeholder.png'; img.alt = app.name || 'preview';
        const info = document.createElement('div'); info.className='info';
        const h3 = document.createElement('h3'); h3.textContent = app.name || 'Sin nombre';
        const small = document.createElement('small'); small.textContent = `${app.category || 'Sin categor√≠a'} ¬∑ ${formatDate(app.created_at || '')}`;
        info.appendChild(h3); info.appendChild(small);
        meta.appendChild(img); meta.appendChild(info);
        card.appendChild(meta);

        // description
        const desc = document.createElement('div'); desc.className='desc'; desc.textContent = app.description || '';
        card.appendChild(desc);

        // actions
        const actions = document.createElement('div'); actions.className='card-actions';
        const link = document.createElement('a'); link.className='link-apk';
        try { link.href = app.apk || '#'; } catch { link.href = '#'; }
        link.target = '_blank'; link.rel='noopener'; link.textContent = '‚¨áÔ∏è Descargar APK';
        actions.appendChild(link);

        const editBtn = document.createElement('button'); editBtn.className='edit'; editBtn.textContent='‚úèÔ∏è Editar';
        editBtn.addEventListener('click', ()=> openEdit(app.id));
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='üóëÔ∏è Eliminar';
        delBtn.addEventListener('click', ()=> confirmDelete(app.id, delBtn));
        actions.appendChild(delBtn);

        card.appendChild(actions);
        appsGrid.appendChild(card);
      });
    }

    // ---------- Fetch apps ----------
    async function fetchApps(){
      try{
        document.getElementById('refreshBtn').textContent = '‚è≥ Cargando...';
        document.getElementById('refreshBtn').disabled = true;
        const data = await safeFetch('/api/apps');
        // backend returns array
        apps = Array.isArray(data) ? data : (data.items || []);
        renderApps();
        populateCategories();
      }catch(err){
        console.error(err);
        appsGrid.innerHTML = '<p style="color:#ef4444">Error cargando apps. Revisa el servidor.</p>';
        showToast(err.message || 'Error cargando apps', false);
      }finally{
        document.getElementById('refreshBtn').textContent = 'üîÑ Actualizar';
        document.getElementById('refreshBtn').disabled = false;
      }
    }

    // ---------- Populate categories ----------
    function populateCategories(){
      const set = new Set(apps.map(a => a.category).filter(Boolean));
      const sel = document.getElementById('categorySelect');
      const current = sel.value;
      sel.innerHTML = '<option value="">Todas las categor√≠as</option>';
      set.forEach(c => {
        const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
      });
      if([...set].includes(current)) sel.value=current;
    }

    // ---------- Delete ----------
    async function confirmDelete(id, btn){
      const ok = confirm('¬øSeguro que deseas eliminar esta app? Esta acci√≥n es irreversible.');
      if(!ok) return;
      try{
        btn.disabled = true;
        btn.textContent = 'Eliminando...';
        const data = await safeFetch(`/apps/${id}`, { method: 'DELETE' });
        apps = apps.filter(a=>a.id!==id);
        renderApps();
        showToast(data.message || 'Eliminado');
      }catch(err){
        console.error(err);
        showToast(err.message || 'Error al eliminar', false);
      }finally{
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è Eliminar';
      }
    }

    // ---------- Modal handling ----------
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalForm = document.getElementById('modalForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalId = document.getElementById('modalId');
    const modalName = document.getElementById('modalName');
    const modalDesc = document.getElementById('modalDesc');
    const modalImage = document.getElementById('modalImage');
    const modalApk = document.getElementById('modalApk');
    const modalPreview = document.getElementById('modalPreview');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const newBtn = document.getElementById('newBtn');

    newBtn.addEventListener('click', ()=> openCreate());
    document.getElementById('refreshBtn').addEventListener('click', fetchApps);

    function openCreate(){
      editingId = null;
      modalTitle.textContent = 'Crear nueva aplicaci√≥n';
      modalId.value = '';
      modalName.value = '';
      modalDesc.value = '';
      modalPreview.src = 'placeholder.png';
      modalImage.value = '';
      modalApk.value = '';
      showModal();
    }

    function openEdit(id){
      const app = apps.find(a=>a.id===id);
      if(!app){ showToast('App no encontrada', false); return; }
      editingId = id;
      modalTitle.textContent = 'Editar aplicaci√≥n';
      modalId.value = id;
      modalName.value = app.name || '';
      modalDesc.value = app.description || '';
      modalPreview.src = app.image || 'placeholder.png';
      modalImage.value = '';
      modalApk.value = '';
      showModal();
    }

    function showModal(){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      // focus trap basic
      const focusables = modalBackdrop.querySelectorAll('a,button,input,textarea,select');
      const first = focusables[0], last = focusables[focusables.length-1];
      function handleKey(e){
        if(e.key !== 'Tab') return;
        if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
      }
      modalBackdrop._keyHandler = handleKey;
      modalBackdrop.addEventListener('keydown', handleKey);
      // set focus
      setTimeout(()=> modalName.focus(), 80);
    }

    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      if(modalBackdrop._keyHandler) modalBackdrop.removeEventListener('keydown', modalBackdrop._keyHandler);
      // revoke object url
      if(lastObjectUrl){ URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
    }

    modalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });

    // preview image on choose
    modalImage.addEventListener('change', (e)=> {
      const f = e.target.files[0];
      if(f){
        if(lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
        lastObjectUrl = URL.createObjectURL(f);
        modalPreview.src = lastObjectUrl;
      }
    });

    // ---------- Submit modal (create or update) ----------
    modalForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = modalName.value.trim();
      const desc = modalDesc.value.trim();
      if(!name){ alert('El nombre es obligatorio'); return; }

      modalSave.disabled = true;
      modalSave.textContent = '‚è≥ Guardando...';

      try{
        const fd = new FormData();
        fd.append('name', name);
        fd.append('description', desc);
        if(modalImage.files[0]) fd.append('image', modalImage.files[0]);
        if(modalApk.files[0]) fd.append('apk', modalApk.files[0]);

        let res;
        if(editingId){
          // PUT /apps/:id
          res = await fetch(`/apps/${editingId}`, { method: 'PUT', body: fd, credentials: 'include' });
        } else {
          // POST /apps
          res = await fetch('/apps', { method: 'POST', body: fd, credentials: 'include' });
        }

        // try parse JSON safely
        const ctype = res.headers.get('content-type') || '';
        const data = ctype.includes('application/json') ? await res.json() : await res.text();

        if(!res.ok){
          const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : 'Error en servidor');
          throw new Error(msg);
        }

        showToast(editingId ? 'Actualizaci√≥n guardada' : 'App creada');
        closeModal();
        await fetchApps();
      }catch(err){
        console.error(err);
        showToast(err.message || 'Error', false);
      }finally{
        modalSave.disabled = false;
        modalSave.textContent = 'Guardar cambios';
      }
    });

    // ---------- Filters ----------
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const sortSelect = document.getElementById('sortSelect');
    const clearFilterBtn = document.getElementById('clearFilter');

    function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }; }
    const debouncedRender = debounce(()=> renderApps(), 220);

    searchInput.addEventListener('input', (e)=>{ filter.q = e.target.value; debouncedRender(); });
    categorySelect.addEventListener('change', (e)=>{ filter.category = e.target.value; renderApps(); });
    sortSelect.addEventListener('change', (e)=>{ filter.sort = e.target.value; renderApps(); });
    clearFilterBtn.addEventListener('click', ()=>{ searchInput.value=''; categorySelect.value=''; sortSelect.value='new'; filter={q:'',category:'',sort:'new'}; renderApps(); });

    // ---------- initial load & splash hide ----------
    window.addEventListener('load', ()=>{
      // hide any splash if present
      const s = document.getElementById('splash');
      if(s){ s.style.display='none'; }
      fetchApps();
    });

    // ---------- keyboard escape closes modal ----------
    window.addEventListener('keydown', (e)=> { if(e.key==='Escape'){ closeModal(); } });

    // ---------- small safety: ensure endpoints exist message ----------
    // If backend responds with HTML (unexpected), show a clear message in console
    (async function checkApi(){
      try{
        const r = await fetch('/api/apps', { credentials: 'include' });
        const ctype = r.headers.get('content-type') || '';
        if(!ctype.includes('application/json')) {
          console.warn('Advertencia: /api/apps no devuelve JSON. Aseg√∫rate de que el backend devuelva JSON para /api/apps.');
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
